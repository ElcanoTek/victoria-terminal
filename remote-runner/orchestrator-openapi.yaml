openapi: 3.0.0
info:
  title: All-Time Quarterback Orchestrator API
  description: |
    OpenAPI specification for the All-Time Quarterback fleet management orchestrator.
    
    This API enables orchestrators to manage Victoria Terminal agents using a pull-based
    hub-and-spoke model. This design ensures that agents only make outbound HTTPS
    connections, requiring no inbound ports to be opened on the agent machines.
    
    Key features:
    - Node registration and heartbeat monitoring
    - Task assignment polling and status reporting
    - Log collection and storage
    - File download for task attachments
    
    ## Authentication
    
    All authenticated endpoints require the `X-API-Key` header. Requests without a valid
    API key will receive a 401 Unauthorized response. Ensure your client is configured
    with the correct API key before making requests to avoid authentication errors that
    may appear as runtime failures.
  version: 1.1.2
  license:
    name: BSL 1.1
    url: https://mariadb.com/bsl11/
servers:
  - url: http://localhost:8000
    description: Local development server
  - url: https://your-orchestrator.example.com
    description: Your orchestrator server
components:
  securitySchemes:
    NodeApiKey:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        Node-specific API key for node operations. Required for all node endpoints.
        Requests without this header will receive a 401 Unauthorized response.
    RegistrationToken:
      type: apiKey
      in: header
      name: X-Registration-Token
      description: Token used for registering new nodes.
  schemas:
    NodeRegistration:
      type: object
      required:
        - hostname
        - os_type
      properties:
        hostname:
          type: string
          description: The hostname of the node.
        name:
          type: string
          description: Optional custom name for the node.
        os_type:
          type: string
          description: Operating system type.
    Node:
      type: object
      required:
        - id
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the node. Always present in all responses.
        hostname:
          type: string
        name:
          type: string
        api_key:
          type: string
          description: |
            The API key assigned to the node. Only included in registration response.
            Not returned by other endpoints for security reasons.
        os_type:
          type: string
        status:
          type: string
          enum: [idle, busy, offline, error]
        last_heartbeat:
          type: string
          format: date-time
        current_task_id:
          type: string
          format: uuid
        registered_at:
          type: string
          format: date-time
    NodeRegistrationResponse:
      description: |
        Response returned when a node is successfully registered. Extends Node
        with required api_key field. The id field is inherited as required from Node.
      allOf:
        - $ref: '#/components/schemas/Node'
        - type: object
          required:
            - api_key
          properties:
            api_key:
              type: string
              description: |
                The API key assigned to the node. This is only returned once during registration.
                Store this securely as it is required for all subsequent node API calls.
    NodeHeartbeat:
      type: object
      required:
        - node_id
        - status
      properties:
        node_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [idle, busy, offline, error]
        current_task_id:
          type: string
          format: uuid
    TaskAssignment:
      type: object
      required:
        - task_id
        - prompt
        - orchestrator_url
      properties:
        task_id:
          type: string
          format: uuid
          description: Unique identifier for the task. Required for status updates.
        prompt:
          type: string
          description: The task prompt/instruction to execute. Required.
        timeout_seconds:
          type: integer
        orchestrator_url:
          type: string
          description: |
            Base URL of the orchestrator for callbacks. Required for status updates
            and log submissions.
        files:
          type: array
          items:
            type: string
          description: |
            List of filenames available for download from /files/{filename}.
            Filenames should be URL-encoded when constructing download URLs.
        file_checksums:
          type: array
          items:
            type: string
          description: |
            List of SHA-256 checksums corresponding to the files array (same order).
            Clients should use these checksums to verify file integrity after download.
            Each checksum is a lowercase hex-encoded SHA-256 hash of the file content.
    StatusUpdate:
      type: object
      description: |
        Status update payload sent by nodes to report task progress.
        
        Note: Only a subset of status values should be reported by agents:
        - running: Task is actively being processed
        - analyzing: Task is in analysis phase  
        - success: Task completed successfully
        - error: Task failed with an error
        
        The following statuses are orchestrator-controlled and should NOT be
        reported by agents:
        - pending: Set when task is created
        - assigned: Set when task is assigned to a node
        - cancelled: Set when admin cancels a task
      required:
        - task_id
        - status
      properties:
        task_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, assigned, running, analyzing, success, error, cancelled]
          description: |
            Current task status. Agents should only report: running, analyzing,
            success, or error. Other values (pending, assigned, cancelled) are
            orchestrator-controlled.
        message:
          type: string
        progress:
          type: number
          format: double
        crush_session_id:
          type: string
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp of when this status update was generated.
    LogSubmission:
      type: object
      description: |
        Submission of session logs. The maximum request body size is 10MB.
      required:
        - task_id
        - session
      properties:
        task_id:
          type: string
          format: uuid
        session:
          $ref: '#/components/schemas/LogSession'
    LogSession:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        prompt_tokens:
          type: integer
        completion_tokens:
          type: integer
        cost:
          type: number
        created_at:
          type: integer
        updated_at:
          type: integer
        messages:
          type: array
          items:
            $ref: '#/components/schemas/LogMessage'
    LogMessage:
      type: object
      properties:
        id:
          type: string
        role:
          type: string
        content:
          type: string
        model:
          type: string
        provider:
          type: string
        created_at:
          type: integer
        finished_at:
          type: integer
paths:
  /register:
    post:
      summary: Register a new node
      description: |
        Register a new node with the orchestrator. On success, the response includes
        the node's `id` and `api_key` which are required for all subsequent API calls.
        Store these values securely.
      security:
        - RegistrationToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NodeRegistration'
      responses:
        '200':
          description: |
            Node registered successfully. The response always includes `id` and `api_key`
            fields which must be stored for subsequent API calls.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NodeRegistrationResponse'
        '401':
          description: Invalid registration token
        '503':
          description: Registration disabled
  /nodes/heartbeat:
    post:
      summary: Node heartbeat
      security:
        - NodeApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NodeHeartbeat'
      responses:
        '200':
          description: Heartbeat accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Node'
  /tasks/pending:
    get:
      summary: Get pending task for node
      description: |
        Retrieve the next pending task assigned to this node. Returns null if no
        task is currently pending. Clients should handle both a TaskAssignment
        object and a null response.
      security:
        - NodeApiKey: []
      responses:
        '200':
          description: |
            Pending task assignment or null if no task is available. When a task
            is returned, the `task_id`, `prompt`, and `orchestrator_url` fields
            are always present.
          content:
            application/json:
              schema:
                nullable: true
                allOf:
                  - $ref: '#/components/schemas/TaskAssignment'
  /files/{filename}:
    get:
      summary: Download a file
      description: |
        Download a task attachment file. Files are associated with tasks and
        should only be accessible to the node assigned to execute the task.
        
        **Important**: The filename parameter must be URL-encoded if it contains
        special characters, spaces, or non-ASCII characters. Failure to properly
        encode the filename may result in 404 errors or unexpected behavior.
        
        Example: A file named "my report.pdf" should be requested as
        `/files/my%20report.pdf`
      security:
        - NodeApiKey: []
      parameters:
        - in: path
          name: filename
          description: |
            The filename to download. Must be URL-encoded if it contains special
            characters, spaces, or reserved URI characters.
          schema:
            type: string
          required: true
      responses:
        '200':
          description: File content
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '401':
          description: Unauthorized - invalid or missing API key
        '404':
          description: File not found
  /status:
    post:
      summary: Report task status
      description: |
        Report the current status of a task execution. The `task_id` and `status`
        fields are required. The optional `timestamp` field should be an ISO 8601
        formatted datetime string.
      security:
        - NodeApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StatusUpdate'
      responses:
        '200':
          description: Status updated
  /logs:
    post:
      summary: Submit session logs
      security:
        - NodeApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LogSubmission'
      responses:
        '200':
          description: Logs accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogSession'
