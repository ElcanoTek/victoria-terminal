openapi: 3.0.0
info:
  title: All-Time Quarterback Orchestrator API
  description: |
    OpenAPI specification for the All-Time Quarterback fleet management orchestrator.
    
    This API enables orchestrators to manage Victoria Terminal agents using a pull-based
    hub-and-spoke model. This design ensures that agents only make outbound HTTPS
    connections, requiring no inbound ports to be opened on the agent machines.
    
    Key features:
    - Node registration and heartbeat monitoring
    - Task creation, assignment, and status tracking
    - Log collection and storage
    - File upload/download for task attachments
    
    ## Authentication
    
    All authenticated endpoints require the `X-API-Key` header. Requests without a valid
    API key will receive a 401 Unauthorized response. Ensure your client is configured
    with the correct API key before making requests to avoid authentication errors that
    may appear as runtime failures.
  version: 1.1.1
  license:
    name: BSL 1.1
    url: https://mariadb.com/bsl11/
servers:
  - url: http://localhost:8000
    description: Local development server
  - url: https://your-orchestrator.example.com
    description: Your orchestrator server
components:
  securitySchemes:
    AdminApiKey:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        Admin API key for privileged operations. Required for all admin endpoints.
        Requests without this header will receive a 401 Unauthorized response.
    NodeApiKey:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        Node-specific API key for node operations. Required for all node endpoints.
        Requests without this header will receive a 401 Unauthorized response.
    RegistrationToken:
      type: apiKey
      in: header
      name: X-Registration-Token
      description: Token used for registering new nodes.
  schemas:
    NodeRegistration:
      type: object
      required:
        - hostname
        - os_type
      properties:
        hostname:
          type: string
          description: The hostname of the node.
        name:
          type: string
          description: Optional custom name for the node.
        os_type:
          type: string
          description: Operating system type.
    Node:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the node.
        hostname:
          type: string
        name:
          type: string
        api_key:
          type: string
          description: |
            The API key assigned to the node. Only included in registration response.
            Not returned by other endpoints for security reasons.
        os_type:
          type: string
        status:
          type: string
          enum: [idle, busy, offline, error]
        last_heartbeat:
          type: string
          format: date-time
        current_task_id:
          type: string
          format: uuid
        registered_at:
          type: string
          format: date-time
    NodeRegistrationResponse:
      description: |
        Response returned when a node is successfully registered. Extends Node
        with required id and api_key fields that must be stored for subsequent API calls.
      allOf:
        - $ref: '#/components/schemas/Node'
        - type: object
          required:
            - id
            - api_key
          properties:
            id:
              type: string
              format: uuid
              description: Unique identifier for the node. Store this for subsequent API calls.
            api_key:
              type: string
              description: |
                The API key assigned to the node. This is only returned once during registration.
                Store this securely as it is required for all subsequent node API calls.
    NodeHeartbeat:
      type: object
      required:
        - node_id
        - status
      properties:
        node_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [idle, busy, offline, error]
        current_task_id:
          type: string
          format: uuid
    TaskCreate:
      type: object
      required:
        - prompt
      properties:
        prompt:
          type: string
          description: The task prompt/instruction.
        target_node_id:
          type: string
          format: uuid
        target_node_name:
          type: string
          description: Wildcard pattern to match node names.
        target_tags:
          type: object
          additionalProperties:
            type: string
        priority:
          type: integer
          default: 0
        timeout_seconds:
          type: integer
          default: 3600
        scheduled_for:
          type: string
          format: date-time
        recurrence:
          type: string
          description: Cron expression for recurring tasks.
        files:
          type: array
          items:
            type: string
    Task:
      type: object
      properties:
        id:
          type: string
          format: uuid
        prompt:
          type: string
        target_node_id:
          type: string
          format: uuid
        target_node_name:
          type: string
        target_tags:
          type: object
          additionalProperties:
            type: string
        priority:
          type: integer
        timeout_seconds:
          type: integer
        status:
          type: string
          enum: [pending, assigned, running, analyzing, success, error, cancelled]
        assigned_node_id:
          type: string
          format: uuid
        crush_session_id:
          type: string
        created_at:
          type: string
          format: date-time
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        result:
          type: string
        error_message:
          type: string
        scheduled_for:
          type: string
          format: date-time
        recurrence:
          type: string
        created_by:
          type: string
          format: uuid
        files:
          type: array
          items:
            type: string
    TaskAssignment:
      type: object
      required:
        - task_id
        - prompt
        - orchestrator_url
      properties:
        task_id:
          type: string
          format: uuid
          description: Unique identifier for the task. Required for status updates.
        prompt:
          type: string
          description: The task prompt/instruction to execute. Required.
        timeout_seconds:
          type: integer
        orchestrator_url:
          type: string
          description: |
            Base URL of the orchestrator for callbacks. Required for status updates
            and log submissions.
        files:
          type: array
          items:
            type: string
          description: |
            List of filenames available for download from /files/{filename}.
            Filenames should be URL-encoded when constructing download URLs.
        file_checksums:
          type: array
          items:
            type: string
          description: List of SHA-256 checksums corresponding to the files.
    StatusUpdate:
      type: object
      required:
        - job_id
        - status
      properties:
        job_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, assigned, running, analyzing, success, error, cancelled]
        message:
          type: string
        progress:
          type: number
          format: double
        crush_session_id:
          type: string
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp of when this status update was generated.
    LogSubmission:
      type: object
      required:
        - job_id
        - session
      properties:
        job_id:
          type: string
          format: uuid
        session:
          $ref: '#/components/schemas/LogSession'
    LogSession:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        prompt_tokens:
          type: integer
        completion_tokens:
          type: integer
        cost:
          type: number
        created_at:
          type: integer
        updated_at:
          type: integer
        messages:
          type: array
          items:
            $ref: '#/components/schemas/LogMessage'
    LogMessage:
      type: object
      properties:
        id:
          type: string
        role:
          type: string
        content:
          type: string
        model:
          type: string
        provider:
          type: string
        created_at:
          type: integer
        finished_at:
          type: integer
    APIKeyCreate:
      type: object
      required:
        - name
        - description
      properties:
        name:
          type: string
        allowed_node_patterns:
          type: array
          items:
            type: string
        role:
          type: string
        rate_limit:
          type: integer
        expires_in_days:
          type: integer
        description:
          type: string
    APIKeyResponse:
      type: object
      properties:
        key_id:
          type: string
        name:
          type: string
        key_prefix:
          type: string
        allowed_node_patterns:
          type: array
          items:
            type: string
        permissions:
          type: array
          items:
            type: string
        rate_limit:
          type: integer
        created_at:
          type: string
          format: date-time
        rotated_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
        enabled:
          type: boolean
        description:
          type: string
    APIKeyCreated:
      allOf:
        - $ref: '#/components/schemas/APIKeyResponse'
        - type: object
          properties:
            api_key:
              type: string
              description: The full API key secret. Only returned once.
    APIKeyRotated:
      allOf:
        - $ref: '#/components/schemas/APIKeyResponse'
        - type: object
          properties:
            api_key:
              type: string
            grace_period_hours:
              type: integer
    AuditLogEntry:
      type: object
      additionalProperties: true
    DashboardStats:
      type: object
      properties:
        total_nodes:
          type: integer
        active_nodes:
          type: integer
        idle_nodes:
          type: integer
        offline_nodes:
          type: integer
        pending_tasks:
          type: integer
        running_tasks:
          type: integer
        completed_tasks_today:
          type: integer
        failed_tasks_today:
          type: integer
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        username:
          type: string
        role:
          type: string
        scopes:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time
    UserCreate:
      type: object
      required:
        - username
        - password
        - role
      properties:
        username:
          type: string
        password:
          type: string
        role:
          type: string
        scopes:
          type: array
          items:
            type: string
    UserLogin:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
        password:
          type: string
    LoginResponse:
      type: object
      properties:
        token:
          type: string
        user:
          $ref: '#/components/schemas/User'
    ErrorResponse:
      type: object
      properties:
        detail:
          type: string
paths:
  /health:
    get:
      summary: Health Check
      responses:
        '200':
          description: System is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  version:
                    type: string
                  timestamp:
                    type: string
  /register:
    post:
      summary: Register a new node
      description: |
        Register a new node with the orchestrator. On success, the response includes
        the node's `id` and `api_key` which are required for all subsequent API calls.
        Store these values securely.
      security:
        - RegistrationToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NodeRegistration'
      responses:
        '200':
          description: |
            Node registered successfully. The response always includes `id` and `api_key`
            fields which must be stored for subsequent API calls.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NodeRegistrationResponse'
        '401':
          description: Invalid registration token
        '503':
          description: Registration disabled
  /nodes:
    get:
      summary: List all nodes
      security:
        - AdminApiKey: []
      responses:
        '200':
          description: List of nodes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Node'
  /nodes/{node_id}:
    get:
      summary: Get node details
      security:
        - AdminApiKey: []
      parameters:
        - in: path
          name: node_id
          schema:
            type: string
            format: uuid
          required: true
      responses:
        '200':
          description: Node details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Node'
        '404':
          description: Node not found
    delete:
      summary: Unregister node
      security:
        - AdminApiKey: []
      parameters:
        - in: path
          name: node_id
          schema:
            type: string
            format: uuid
          required: true
      responses:
        '200':
          description: Node unregistered
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  node_id:
                    type: string
  /nodes/heartbeat:
    post:
      summary: Node heartbeat
      security:
        - NodeApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NodeHeartbeat'
      responses:
        '200':
          description: Heartbeat accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Node'
  /tasks:
    post:
      summary: Create a task
      security:
        - AdminApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskCreate'
      responses:
        '200':
          description: Task created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
    get:
      summary: List all tasks
      security:
        - AdminApiKey: []
      parameters:
        - in: query
          name: status_filter
          schema:
            type: string
      responses:
        '200':
          description: List of tasks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Task'
  /tasks/pending:
    get:
      summary: Get pending task for node
      description: |
        Retrieve the next pending task assigned to this node. Returns null if no
        task is currently pending. Clients should handle both a TaskAssignment
        object and a null response.
      security:
        - NodeApiKey: []
      responses:
        '200':
          description: |
            Pending task assignment or null if no task is available. When a task
            is returned, the `task_id`, `prompt`, and `orchestrator_url` fields
            are always present.
          content:
            application/json:
              schema:
                nullable: true
                allOf:
                  - $ref: '#/components/schemas/TaskAssignment'
  /tasks/{task_id}:
    get:
      summary: Get task details
      security:
        - AdminApiKey: []
      parameters:
        - in: path
          name: task_id
          schema:
            type: string
            format: uuid
          required: true
      responses:
        '200':
          description: Task details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
    delete:
      summary: Cancel a task
      security:
        - AdminApiKey: []
      parameters:
        - in: path
          name: task_id
          schema:
            type: string
            format: uuid
          required: true
      responses:
        '200':
          description: Task cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
  /tasks/cleanup:
    post:
      summary: Delete old history
      security:
        - AdminApiKey: []
      parameters:
        - in: query
          name: days
          schema:
            type: integer
            default: 7
      responses:
        '200':
          description: Cleanup successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  deleted_count:
                    type: integer
  /upload:
    post:
      summary: Upload a temporary file
      security:
        - AdminApiKey: []
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: File uploaded
          content:
            application/json:
              schema:
                type: object
                properties:
                  filename:
                    type: string
                    description: |
                      The stored filename. This may differ from the original filename
                      and should be used when constructing download URLs.
                  original_name:
                    type: string
                  checksum:
                    type: string
                    description: SHA-256 checksum of the uploaded file.
                  size:
                    type: integer
                    description: Size of the uploaded file in bytes.
  /files/{filename}:
    get:
      summary: Download a file
      description: |
        Download a task attachment file. Files are associated with tasks and
        should only be accessible to the node assigned to execute the task.
        
        **Important**: The filename parameter must be URL-encoded if it contains
        special characters, spaces, or non-ASCII characters. Failure to properly
        encode the filename may result in 404 errors or unexpected behavior.
        
        Example: A file named "my report.pdf" should be requested as
        `/files/my%20report.pdf`
      security:
        - NodeApiKey: []
      parameters:
        - in: path
          name: filename
          description: |
            The filename to download. Must be URL-encoded if it contains special
            characters, spaces, or reserved URI characters.
          schema:
            type: string
          required: true
      responses:
        '200':
          description: File content
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '401':
          description: Unauthorized - invalid or missing API key
        '404':
          description: File not found
  /auth/login:
    post:
      summary: User login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserLogin'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
  /users:
    post:
      summary: Create user
      security:
        - AdminApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserCreate'
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
  /status:
    post:
      summary: Report task status
      description: |
        Report the current status of a task execution. The `job_id` and `status`
        fields are required. The optional `timestamp` field should be an ISO 8601
        formatted datetime string.
      security:
        - NodeApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StatusUpdate'
      responses:
        '200':
          description: Status updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
  /logs:
    post:
      summary: Submit session logs
      security:
        - NodeApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LogSubmission'
      responses:
        '200':
          description: Logs accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogSession'
  /logs/{task_id}:
    get:
      summary: Get task logs
      security:
        - AdminApiKey: []
      parameters:
        - in: path
          name: task_id
          schema:
            type: string
            format: uuid
          required: true
      responses:
        '200':
          description: Task logs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogSession'
  /keys:
    post:
      summary: Create API key
      security:
        - AdminApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/APIKeyCreate'
      responses:
        '200':
          description: API key created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIKeyCreated'
    get:
      summary: List API keys
      security:
        - AdminApiKey: []
      responses:
        '200':
          description: List of API keys
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/APIKeyResponse'
  /keys/audit:
    get:
      summary: Get audit log
      security:
        - AdminApiKey: []
      parameters:
        - in: query
          name: key_id
          schema:
            type: string
        - in: query
          name: action
          schema:
            type: string
        - in: query
          name: hours
          schema:
            type: integer
            default: 24
        - in: query
          name: limit
          schema:
            type: integer
            default: 100
      responses:
        '200':
          description: Audit log
          content:
            application/json:
              schema:
                type: object
                properties:
                  entries:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuditLogEntry'
                  total:
                    type: integer
  /keys/{key_id}:
    get:
      summary: Get API key details
      security:
        - AdminApiKey: []
      parameters:
        - in: path
          name: key_id
          schema:
            type: string
          required: true
      responses:
        '200':
          description: API key details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIKeyResponse'
    delete:
      summary: Delete API key
      security:
        - AdminApiKey: []
      parameters:
        - in: path
          name: key_id
          schema:
            type: string
          required: true
      responses:
        '200':
          description: API key deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  deleted:
                    type: boolean
                  key_id:
                    type: string
  /keys/{key_id}/rotate:
    post:
      summary: Rotate API key
      security:
        - AdminApiKey: []
      parameters:
        - in: path
          name: key_id
          schema:
            type: string
          required: true
        - in: query
          name: grace_period_hours
          schema:
            type: integer
            default: 24
      responses:
        '200':
          description: API key rotated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIKeyRotated'
  /keys/{key_id}/revoke:
    post:
      summary: Revoke API key
      security:
        - AdminApiKey: []
      parameters:
        - in: path
          name: key_id
          schema:
            type: string
          required: true
      responses:
        '200':
          description: API key revoked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIKeyResponse'
  /dashboard:
    get:
      summary: Dashboard UI
      responses:
        '200':
          description: HTML Dashboard
          content:
            text/html:
              schema:
                type: string
  /dashboard/stats:
    get:
      summary: Dashboard statistics
      security:
        - AdminApiKey: []
      responses:
        '200':
          description: Statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardStats'
